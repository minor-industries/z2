{{ template "header" . }}

<div class="pure-g">
    <div class="pure-u-1 pure-u-md-1-3">
        <form class="pure-form pure-form-stacked" id="sync-form">
            <fieldset>
                <legend>Sync Configuration</legend>

                <label for="host">Host</label>
                <input id="host" type="text" placeholder="localhost:8080" required>

                <label for="lookback">Lookback Days</label>
                <input id="lookback" type="number" placeholder="7" required>

                <label for="database">Destination Database</label>
                <input id="database" type="text" placeholder="Database" required>

                <button type="button" id="start-sync" class="pure-button pure-button-primary">Go</button>
            </fieldset>
        </form>
    </div>
</div>

<div class="pure-g">
    <div class="pure-u-1">
        <h2>Sync Logs</h2>
        <pre id="log-output" class="pure-pre"></pre>
    </div>
</div>


<script type="module">
    import {getEnv} from "/env.js"

    function sse(host, lookback, database, logOutput) {
        const sseUrl = `/trigger-sync?host=${encodeURIComponent(host)}&lookback=${lookback}&database=${encodeURIComponent(database)}`;

        const eventSource = new EventSource(sseUrl);

        eventSource.onmessage = function (event) {
            logOutput.textContent += event.data + '\n';
        };

        // TODO: add a close event and differentiate from log events

        eventSource.onerror = function (err) {
            logOutput.textContent += `connection closed or errored\n`;
            eventSource.close();
        };
    }

    function wasm(host, lookback, database, logOutput) {
        window.z2GoWasm.z2.triggerSync();
    }

    document.addEventListener("DOMContentLoaded", async () => {
        const env = await getEnv();

        document.getElementById('start-sync').addEventListener('click', async () => {
            const host = document.getElementById('host').value;
            const lookback = document.getElementById('lookback').value;
            const database = document.getElementById('database').value;

            const logOutput = document.getElementById('log-output');
            logOutput.textContent = '';

            // sse(host, lookback, database, logOutput);
            wasm(host, lookback, database, logOutput);
        });
    })
</script>


{{ template "footer" . }}