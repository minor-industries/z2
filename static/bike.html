<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bike</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="/rtgraph/dygraph.css"/>
    <link rel="stylesheet" type="text/css" href="/rtgraph/rtgraph.css"/>

    <link rel="stylesheet" type="text/css" href="/rtgraph/purecss/base-min.css">
    <link rel="stylesheet" type="text/css" href="/rtgraph/purecss/pure-min.css">
    <link rel="stylesheet" type="text/css" href="/rtgraph/purecss/grids-responsive-min.css">

    <script type="text/javascript" src="/rtgraph/dygraph.min.js"></script>
    <script type="text/javascript" src="/rtgraph/msgpack.min.js"></script>

    <style>
        .speed-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 50px;
        }

        .speed-display {
            width: 100px;
            text-align: center;
            font-size: 1.5em;
            margin-right: 10px;
        }

        .speed-buttons {
            display: flex;
            flex-direction: column;
        }

        .speed-button {
            margin: 5px;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            text-align: center;
            cursor: pointer;
        }
    </style>

    <script type="module">
        import {Graph} from '/rtgraph/rtgraph.js';

        document.addEventListener("DOMContentLoaded", () => {
            const second = 1000;
            const minute = second * 60;
            const seriesOpts = {
                y2: {strokeWidth: 1.0},
                y3: {strokeWidth: 1.0, color: "red"},
                y4: {strokeWidth: 1.0, color: "red"},
            }

            new Graph(document.getElementById("graphdiv0"), {
                seriesNames: [
                    "bike_instant_speed | mygate bike_target_speed bike_max_drift_pct | gt 20 | avg 30s triangle",
                    "bike_instant_speed | mygate bike_target_speed bike_max_drift_pct",
                    "bike_instant_speed_min",
                    "bike_instant_speed_max",
                ],
                title: "Speed: {value}",
                ylabel: "speed (km/h)",
                windowSize: minute,
                height: 250,
                series: seriesOpts,
                maxGapMs: 5 * second
            });

            new Graph(document.getElementById("graphdiv1"), {
                seriesNames: [
                    "bike_instant_cadence | gt 30 | avg 30s triangle",
                    "bike_instant_cadence"
                ],
                title: "Cadence: {value}",
                ylabel: "cadence (rpm)",
                windowSize: minute,
                height: 250,
                series: seriesOpts,
                maxGapMs: 5 * second
            });

            new Graph(document.getElementById("graphdiv2"), {
                seriesNames: [
                    "bike_instant_power | gt 150 | avg 30s triangle",
                    "bike_instant_power"
                ],
                title: "Power: {value}",
                ylabel: "power (watts)",
                windowSize: minute,
                height: 250,
                series: seriesOpts,
                maxGapMs: 5 * second
            });

            new Graph(document.getElementById("graphdiv5"), {
                seriesNames: [
                    "bike_instant_speed | mygate bike_target_speed bike_max_drift_pct | gt 20 | avg 10m triangle"
                ],
                title: "Avg Speed: {value}",
                ylabel: "speed (km/h)",
                windowSize: 15 * minute,
                height: 250,
                maxGapMs: 5 * second
            });

            new Graph(document.getElementById("graphdiv4"), {
                seriesNames: [
                    "heartrate | gt 0 | avg 2m triangle",
                    "heartrate | gt 0"
                ],
                title: "Heartrate: {value}",
                ylabel: "bpm",
                windowSize: 15 * minute,
                height: 250,
                series: seriesOpts,
                maxGapMs: 5 * second
            });

            new Graph(document.getElementById("graphdiv6"), {
                seriesNames: [
                    "fairway",
                    "too_fast",
                    "too_slow",
                ],
                title: "pace",
                ylabel: "y",
                windowSize: minute,
                height: 250,
                series: {
                    y1: {strokeWidth: 1.0},
                    y2: {strokeWidth: 1.0},
                    y3: {strokeWidth: 1.0}
                },
                maxGapMs: 5 * second
            });

            new Graph(document.getElementById("graphdiv7"), {
                seriesNames: [
                    "bike_instant_speed | mygate bike_target_speed bike_max_drift_pct",
                ],
                title: "gated speed",
                ylabel: "speed",
                windowSize: minute,
                height: 250,
                series: seriesOpts,
                maxGapMs: 5 * second
            });
        });
    </script>
</head>
<body>
<div class="pure-g">
    <div class="pure-u-1 pure-u-sm-1-3">
        <div id="graphdiv0" class="rtgraph-graph"></div>
    </div>

    <div class="pure-u-1 pure-u-sm-2-3">
        <div id="graphdiv5" class="rtgraph-graph"></div>
    </div>

    <div class="pure-u-1 pure-u-sm-1-3">
        <div id="graphdiv2" class="rtgraph-graph"></div>
    </div>

    <div class="pure-u-1 pure-u-sm-2-3">
        <div id="graphdiv4" class="rtgraph-graph"></div>
    </div>

    <div class="pure-u-1 pure-u-sm-1-3">
        <div id="graphdiv1" class="rtgraph-graph"></div>
    </div>

    <div class="pure-u-1 pure-u-sm-1-3">
        <div id="graphdiv6" class="rtgraph-graph"></div>
    </div>

    <div class="pure-u-1 pure-u-sm-1-3">
        <div id="graphdiv7" class="rtgraph-graph"></div>
    </div>

    <div class="pure-u-1">
        <div class="speed-container">
            <label for="speed-display" style="margin-right: 10px;">Target Speed:</label>
            <input type="text" id="speed-display" class="pure-input-1 speed-display" readonly>
            <div class="speed-buttons">
                <button class="pure-button pure-button-primary speed-button" onclick="changeSpeed(0.5)">▲</button>
                <button class="pure-button pure-button-primary speed-button" onclick="changeSpeed(-0.5)">▼</button>
            </div>
        </div>
    </div>

    <script type="module">
        import {ReadVariables, UpdateVariables} from "./api.js"

        const bikeTargetSpeed = "bike_target_speed";

        document.addEventListener('DOMContentLoaded', (event) => {
            fetchInitialSpeed();
        });

        async function fetchInitialSpeed() {

            const resp = await ReadVariables({
                variables: [bikeTargetSpeed]
            })

            resp.variables.forEach(v => {
                switch (v.name) {
                    case bikeTargetSpeed:
                        updateSpeed(v.value);
                        return;
                }
            })
        }

        function updateSpeed(value) {
            const display = document.getElementById('speed-display');
            display.value = value;
        }

        function changeSpeed(delta) {
            const display = document.getElementById('speed-display');
            let currentSpeed = parseFloat(display.value);
            currentSpeed += delta;
            display.value = currentSpeed;
            updateSpeedBackend(currentSpeed);
        }

        window.changeSpeed = changeSpeed;

        function updateSpeedBackend(newSpeed) {
            UpdateVariables({
                variables: [
                    {
                        name: bikeTargetSpeed,
                        value: newSpeed,
                        present: true,
                    },
                ]
            })
        }

    </script>
</div>

</body>
</html>